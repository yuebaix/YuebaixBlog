+++
title       = "七天构建SpringCloud集群"
subtitle    = "day3："
description = "服务注册、在线文档"
author      = "月白"
date        = 2021-10-03T19:00:00+08:00
URL         = ""
image       = ""
categories  = ["TECH"]
tags        = ["干货", "教程"]
showtoc     = true
+++

项目地址：[jiuzhou (九州) https://github.com/yuebaix/jiuzhou](https://github.com/yuebaix/jiuzhou)

<a style="display: inline-block;width: 400px;height: 170px" target="_blank" href="https://github.com/yuebaix/jiuzhou">
    <img align="left" src="https://github-readme-stats.vercel.app/api/pin/?username=yuebaix&theme=highcontrast&repo=jiuzhou" />
</a>

## 一、完成服务注册功能

1.引入zookeeper、spring-cloud-starter-zookeeper-discovery依赖

```groovy
ext {
    zookeeperVersion = '3.7.0'
}

dependencyManagement {
    dependency "org.apache.zookeeper:zookeeper:${zookeeperVersion}"
}

dependencies {
    implementation('org.springframework.cloud:spring-cloud-starter-zookeeper-discovery') {
        exclude group: 'org.apache.zookeeper', module: 'zookeeper'
    }
    implementation ('org.apache.zookeeper:zookeeper') {
        exclude group: 'org.slf4j', module: 'slf4j-log4j12'
    }
}
```

2.配置文件application.properties添加服务发现配置

```properties
spring.application.name=app-bizagg

spring.cloud.inetutils.preferredNetworks[0] = 192
#spring.cloud.inetutils.preferredNetworks[1] = 172

spring.cloud.zookeeper.connect-string=localhost:12181
spring.cloud.zookeeper.discovery.enabled=true
spring.cloud.zookeeper.discovery.register=true
spring.cloud.zookeeper.discovery.root=/jiuzhou
spring.cloud.zookeeper.discovery.instance-host=${spring.cloud.client.ip-address}

server.port=12201
```

3.启动类添加服务发现注解 @EnableDiscoveryClient

```java
@EnableDiscoveryClient
@SpringBootApplication
public class BizAggApp {
    public static void main(String[] args) {
        SpringApplication.run(BizAggApp.class, args);
    }
}
```

4.改动变更到所有服务并进行启动测试

![](/pic/2021_10_03/services_dashboard.png)

![](/pic/2021_10_03/zkCli.png)

![](/pic/2021_10_03/registry_json.png)

## 二、完成swagger文档功能

1.添加swagger文档相关gradle配置

```groovy
implementation 'io.swagger:swagger-annotations'
implementation 'io.swagger:swagger-models'
implementation 'io.springfox:springfox-boot-starter'
```

2.添加swagger配置文件

```java
@Configuration
@EnableOpenApi
@Slf4j
public class SwaggerConfig {
    @Bean("DefaultDocket")
    @ConditionalOnMissingBean(Docket.class)
    public Docket defaultDocket() {
        return new Docket(DocumentationType.OAS_30)
                .groupName("default")
                .apiInfo(apiInfo())
                .useDefaultResponseMessages(false)
                //.pathMapping(socialGraphServiceProperties.getContextPath())
                .select()
                //扫描注解了@ApiOperation的方法生成API接口文档
                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))
                .paths(PathSelectors.any())
                .build();
    }

    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("ApiDoc")
                .contact(new Contact("yuebaix", "https://github.com/yuebaix", "yuebaix@outlook.com"))
                .version("1.0.0")
                .description("ApiDoc generated by jiuzhou")
                .build();
    }
}
```

3.改动变更到所有服务并进行启动测试

[http://localhost:12001/swagger-ui/](http://localhost:12001/swagger-ui/)

[http://localhost:12001/doc.html](http://localhost:12001/doc.html)

![](/pic/2021_10_03/swagger_doc.png)

![](/pic/2021_10_03/knife_doc.png)

## 三、开发日志